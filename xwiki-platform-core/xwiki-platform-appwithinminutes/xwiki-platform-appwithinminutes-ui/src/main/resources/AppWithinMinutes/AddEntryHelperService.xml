<?xml version="1.0" encoding="UTF-8"?>

<xwikidoc>
  <web>AppWithinMinutes</web>
  <name>AddEntryHelperService</name>
  <language/>
  <defaultLanguage/>
  <translation>0</translation>
  <parent>AppWithinMinutes.LiveTableClass</parent>
  <creator>xwiki:XWiki.Admin</creator>
  <author>xwiki:XWiki.Admin</author>
  <customClass/>
  <contentAuthor>xwiki:XWiki.Admin</contentAuthor>
  <creationDate>1321361413000</creationDate>
  <date>1321380065000</date>
  <contentUpdateDate>1321380065000</contentUpdateDate>
  <version>1.1</version>
  <title></title>
  <template/>
  <defaultTemplate/>
  <validationScript/>
  <comment/>
  <minorEdit>false</minorEdit>
  <syntaxId>xwiki/2.1</syntaxId>
  <hidden>true</hidden>
  <content>{{velocity}}
####################################################
##    AppWithinMinutes: Add Entry Helper Service
##
## This service takes a parameter 'entryName' and say:
## - if this entry already exist
## - if the current user has the edit right on it
## - if the current user has the view right on it.
## The other parameter is 'entrySpace', that set the
##   space where the entry should be added
####################################################
#if($xcontext.action == 'get' &amp;&amp; "$!{request.outputSyntax}" == 'plain')
  #set($discard = $response.setContentType('application/json'))
#end
#set($entryName = $request.entryName)
#set($entrySpace = $request.entrySpace)
#set($map = {})
#if("$!entryName" != '' &amp;&amp; "$!entrySpace" != '')
  #set($entryReference = $services.model.createDocumentReference('', $entrySpace, $entryName))
  #if(!$xwiki.exists($entryReference))
    #set($discard = $map.put('action', 'create'))
  #else
    #set($entryFullName = $entryReference.toString())
    #if($xwiki.hasAccessLevel('edit', $xcontext.user, $entryFullName))
      #set($discard = $map.put('action', 'edit'))
    #elseif($xwiki.hasAccessLevel('view', $xcontext.user, $entryFullName))
      #set($discard = $map.put('action', 'view'))
    #else
      #set($discard = $map.put('action', 'forbid'))
    #end
  #end
#end
$jsontool.serialize($map)
{{/velocity}}</content>
</xwikidoc>